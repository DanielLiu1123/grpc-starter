# gRPC Client Processor

This module provides functionality to scan the classpath for gRPC client stubs and generate a Spring Configuration class that registers all found clients as Spring beans.

## Features

- Uses Spring's `ClassPathScanningCandidateComponentProvider` for efficient classpath scanning
- Automatically discovers all gRPC client stub classes (classes extending `AbstractStub`)
- Generates a Spring `@Configuration` class with bean definitions for all discovered clients
- Supports custom authority configuration (default: `localhost:9090`)
- Supports scanning specific packages or common gRPC packages

## Usage

### Programmatic Usage

```java
import grpcstarter.processor.GrpcClientProcessor;
import java.io.File;

public class Example {
    public static void main(String[] args) throws Exception {
        GrpcClientProcessor processor = new GrpcClientProcessor();
        
        // Generate configuration file
        File outputFile = processor.process(
            new File("src/main/java"),           // output directory
            "com.example.config",                 // package name
            "GrpcClientConfiguration",            // class name
            "io.grpc", "com.example"             // packages to scan
        );
        
        System.out.println("Generated: " + outputFile);
    }
}
```

### With Custom Authority

```java
GrpcClientProcessor processor = new GrpcClientProcessor("example.com:8080");
File outputFile = processor.process(
    new File("src/main/java"),
    "com.example.config",
    "GrpcClientConfiguration",
    "com.example"
);
```

### Generate as String

```java
GrpcClientProcessor processor = new GrpcClientProcessor();
String configCode = processor.processToString(
    "com.example.config",
    "GrpcClientConfiguration",
    "com.example"
);
System.out.println(configCode);
```

### Command Line Usage

```bash
java -cp grpc-client-processor.jar grpcstarter.processor.GrpcClientProcessor \
    <outputDir> <packageName> <className> [basePackages...]
```

Example:
```bash
java -cp grpc-client-processor.jar grpcstarter.processor.GrpcClientProcessor \
    src/main/java com.example.config GrpcClientConfiguration io.grpc com.example
```

## Generated Configuration Example

For a project with `UserServiceGrpc.UserServiceBlockingStub` and `OrderServiceGrpc.OrderServiceStub`, the processor will generate:

```java
package com.example.config;

import io.grpc.Channel;
import io.grpc.ManagedChannel;
import io.grpc.ManagedChannelBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Lazy;
import jakarta.annotation.PreDestroy;

import com.example.UserServiceGrpc.UserServiceBlockingStub;
import com.example.OrderServiceGrpc.OrderServiceStub;

/**
 * Auto-generated Spring Configuration for gRPC clients.
 * Generated by grpc-client-processor.
 */
@Configuration
public class GrpcClientConfiguration {

    private ManagedChannel channel;

    @Bean
    public ManagedChannel grpcChannel() {
        if (channel == null) {
            channel = ManagedChannelBuilder.forTarget("localhost:9090")
                    .usePlaintext()
                    .build();
        }
        return channel;
    }

    @Bean
    @Lazy
    public UserServiceBlockingStub userServiceBlockingStub(ManagedChannel channel) {
        return UserServiceGrpc.newBlockingStub(channel);
    }

    @Bean
    @Lazy
    public OrderServiceStub orderServiceStub(ManagedChannel channel) {
        return OrderServiceGrpc.newStub(channel);
    }

    @PreDestroy
    public void shutdown() {
        if (channel != null && !channel.isShutdown()) {
            channel.shutdown();
        }
    }
}
```

## Components

### GrpcClientScanner

Scans the classpath for gRPC client stub classes using ClassGraph.

```java
GrpcClientScanner scanner = new GrpcClientScanner();
List<Class<?>> clients = scanner.scanGrpcClients("io.grpc", "com.example");
```

### GrpcClientConfigurationGenerator

Generates Spring Configuration source code for discovered client stubs.

```java
GrpcClientConfigurationGenerator generator = new GrpcClientConfigurationGenerator("localhost:9090");
String code = generator.generateConfiguration("com.example.config", "GrpcClientConfiguration", clientClasses);
```

### GrpcClientProcessor

Main processor that combines scanning and generation.

```java
GrpcClientProcessor processor = new GrpcClientProcessor();
File outputFile = processor.process(outputDir, packageName, className, basePackages);
```

## Dependencies

- gRPC Stub
- Spring Context
- Spring Beans
- SLF4J API

## Notes

- All generated client beans are marked with `@Lazy` to avoid unnecessary initialization
- The generated configuration includes a `@PreDestroy` method to properly shutdown the gRPC channel
- The scanner looks for classes that:
  - End with "Stub"
  - Extend `io.grpc.stub.AbstractStub`
- Supports all three types of gRPC stubs:
  - Blocking stubs (created with `newBlockingStub`)
  - Async stubs (created with `newStub`)
  - Future stubs (created with `newFutureStub`)

